<!-- static/index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>mini-chat</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@heroicons/react@2.0.18/24/solid"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="login" class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
            <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">Welcome to Chat</h1>
            <div class="space-y-4">
                <div class="relative">
                    <input type="text" 
                           id="username" 
                           placeholder="Enter your username" 
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                    >
                </div>
                <button onclick="connect()" 
                        class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors duration-200 flex items-center justify-center space-x-2">
                    <span>Join Chat</span>
                </button>
            </div>
        </div>
    </div>

    <div id="chat" style="display: none;" class="container mx-auto max-w-4xl h-screen p-4">
        <div class="bg-white rounded-lg shadow-lg h-full flex flex-col">
            <div class="p-4 border-b flex justify-between items-center bg-white rounded-t-lg">
                <div class="flex items-center space-x-2">
                    <div class="h-3 w-3 bg-green-500 rounded-full" id="connection-indicator"></div>
                    <span id="connection-status" class="text-gray-600 font-medium"></span>
                </div>
                <button onclick="disconnect()" 
                        class="text-gray-500 hover:text-red-500 transition-colors duration-200">
                    Disconnect
                </button>
            </div>

            <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4"></div>

            <div class="p-4 border-t bg-white rounded-b-lg">
                <div class="flex space-x-2">
                    <input type="text" 
                           id="message" 
                           placeholder="Type your message..." 
                           class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                    >
                    <button onclick="sendMessage()" 
                            class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors duration-200 flex items-center space-x-2">
                        <span>Send</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let username;
        
        function appendMessage(message, type = 'normal') {
            const messageDiv = document.getElementById('messages');
            const time = new Date().toLocaleTimeString();
            let messageHtml = '';
            
            if (type === 'system') {
                messageHtml = `
                    <div class="flex justify-center">
                        <div class="bg-gray-100 text-gray-600 px-4 py-2 rounded-full text-sm">
                            ${message.content}
                        </div>
                    </div>`;
            } else if (type === 'error') {
                messageHtml = `
                    <div class="flex justify-center">
                        <div class="bg-red-100 text-red-600 px-4 py-2 rounded-lg text-sm">
                            ${message}
                        </div>
                    </div>`;
            } else {
                const isOwnMessage = message.sender === username;
                messageHtml = `
                    <div class="flex ${isOwnMessage ? 'justify-end' : 'justify-start'}">
                        <div class="${isOwnMessage ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'} px-4 py-2 rounded-lg max-w-xs break-words">
                            ${!isOwnMessage ? `<div class="font-medium text-sm mb-1">${message.sender}</div>` : ''}
                            <div>${message.content}</div>
                            <div class="text-xs ${isOwnMessage ? 'text-blue-100' : 'text-gray-500'} mt-1">${time}</div>
                        </div>
                    </div>`;
            }
            
            messageDiv.innerHTML += messageHtml;
            messageDiv.scrollTop = messageDiv.scrollHeight;
        }

        function updateConnectionStatus(status) {
            const indicator = document.getElementById('connection-indicator');
            const statusText = document.getElementById('connection-status');
            
            statusText.textContent = status;
            if (status === 'Connected') {
                indicator.classList.remove('bg-red-500', 'bg-yellow-500');
                indicator.classList.add('bg-green-500');
            } else if (status === 'Disconnected') {
                indicator.classList.remove('bg-green-500', 'bg-yellow-500');
                indicator.classList.add('bg-red-500');
            }
        }

        function disconnect() {
            if (ws) {
                ws.close();
            }
        }
        
        function connect() {
            username = document.getElementById('username').value.trim();
            if (!username) {
                alert('Please enter a username');
                return;
            }

            if (ws) {
                ws.close();
            }

            try {
                ws = new WebSocket(`ws://localhost:8080/ws?username=${encodeURIComponent(username)}`);
                
                ws.onopen = function() {
                    document.getElementById('login').style.display = 'none';
                    document.getElementById('chat').style.display = 'flex';
                    updateConnectionStatus('Connected');
                    appendMessage({content: 'Connected to chat server'}, 'system');
                };

                ws.onmessage = function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        console.log('Received message:', message);
                        
                        if (!message.type || !message.content) {
                            console.error('Invalid message format:', message);
                            return;
                        }
                        
                        if (message.type === 'system') {
                            appendMessage(message, 'system');
                        } else if (message.type === 'chat') {
                            appendMessage(message, 'normal');
                        } else {
                            console.warn('Unknown message type:', message.type);
                        }
                    } catch (e) {
                        console.error('Error handling message:', e);
                        appendMessage('Error handling message: ' + e.message, 'error');
                    }
                };

                ws.onclose = function() {
                    updateConnectionStatus('Disconnected');
                    appendMessage({content: 'Disconnected from server'}, 'system');
                    document.getElementById('login').style.display = 'flex';
                    document.getElementById('chat').style.display = 'none';
                };

                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    appendMessage('WebSocket error occurred', 'error');
                };

            } catch (e) {
                console.error('Connection error:', e);
                appendMessage('Failed to connect: ' + e.message, 'error');
            }
        }

        function sendMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                appendMessage('Not connected to server', 'error');
                return;
            }

            const messageInput = document.getElementById('message');
            const content = messageInput.value.trim();
            
            if (!content) {
                return;
            }

            const message = {
                type: 'chat',
                content: content,
                sender: username
            };

            try {
                ws.send(JSON.stringify(message));
                messageInput.value = '';
            } catch (e) {
                console.error('Error sending message:', e);
                appendMessage('Error sending message: ' + e.message, 'error');
            }
        }

        // support enter to send message
        document.getElementById('message').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // support enter to join chat
        document.getElementById('username').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                connect();
            }
        });
    </script>
</body>
</html>